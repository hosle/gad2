package com.game.adshow;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.List;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.protocol.HTTP;
import org.apache.http.util.EntityUtils;
import org.json.JSONException;
import org.json.JSONObject;

import com.qq.e.ads.AdListener;
import com.qq.e.ads.AdRequest;

import net.youmi.android.banner.AdSize;
import net.youmi.android.banner.AdView;
import net.youmi.android.banner.AdViewListener;
import android.app.Activity;
import android.content.Context;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.view.Gravity;
import android.widget.FrameLayout;
import android.widget.Toast;

public class showBannerAd {

	private Context mContext;
	private Activity mActivity;
	private FrameLayout.LayoutParams layoutParams;
	private String flagString="";
	private Thread mThread_applyAd;
	private Thread mThread_postrecord;
	private  Handler mhandler_applyAd;
	private Handler mHandler_postrecord;
	
	
	public showBannerAd(Context vContext) {
		// TODO Auto-generated constructor stub
		mContext=vContext;
		mActivity=(Activity)vContext;
		
		init();
	}
	
	private void init(){
		// 实例化LayoutParams(重要)
		layoutParams = new FrameLayout.LayoutParams(FrameLayout.LayoutParams.WRAP_CONTENT,
				FrameLayout.LayoutParams.WRAP_CONTENT);
		// 设置广告条的悬浮位置
		layoutParams.gravity = Gravity.BOTTOM | Gravity.RIGHT; // 这里示例为右下角
		
		mhandler_applyAd=new Handler(){
			@Override
			public void handleMessage(Message msg) {
				// TODO Auto-generated method stub
				if (msg.what==200) {
					try {
						String resultString=msg.obj.toString();
						
						JSONObject jObj=new JSONObject(resultString);
						flagString=jObj.getString("info");
						
						Log.i("test", "handler"+resultString);
						toast(flagString);
						
						//根据结果展示banner
						switch (AD.toAD(flagString.toUpperCase())) {
						case YOUMI:
							showBanner_youmi(layoutParams);
							break;
						case BAIDU:
							showBanner_baidu(layoutParams);
							break;
						case GDT:
							showBanner_gdt(layoutParams);
							break;
						default:
							break;
						}
					} catch (JSONException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					//mThread_applyAd.destroy();
				}
			}
		};
		
		mHandler_postrecord=new Handler(){
			@Override
			public void handleMessage(Message msg) {
				// TODO Auto-generated method stub
				if (msg.what==200) {
					String resultString=msg.obj.toString();
					toast(resultString);
					
				}
			}
		};
	}
	public void showBanner(){
		
		getDataFromBackend("http://113.10.157.125:3000/search");
		
	}
	//枚举每个广告商
	private enum AD{
		BAIDU,GDT,YOUMI,NOVALUE;
		
		public static AD toAD(String str) {
			try {
				return valueOf(str);
			} catch (Exception e) {
				// TODO: handle exception
				return NOVALUE;
			}
		}
	}
	private void getDataFromBackend(final String urlString) {
		mThread_applyAd=new Thread(){
			
			@Override
			public void run() {
				// TODO Auto-generated method stub
				Message msg=new Message();
				String result="";
				HttpGet httpGet=new HttpGet(urlString);
				HttpResponse response;
				try {
					response = new DefaultHttpClient().execute(httpGet);
					int statusCode = response.getStatusLine().getStatusCode();
					if (statusCode==200) {
						HttpEntity entity=response.getEntity();
						result=EntityUtils.toString(entity, HTTP.UTF_8);
					}
					msg.what=statusCode;
					msg.obj=result;
					mhandler_applyAd.sendMessage(msg);
					
				} catch (ClientProtocolException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				
			}
		};
		mThread_applyAd.start();
		
		
	}
	
	private void postDataToBackend(final String urlString){
		mThread_postrecord=new Thread(){
			@Override
			public void run() {
				// TODO Auto-generated method stub
				Message msg=new Message();
				HttpPost httpPost=new HttpPost(urlString);
				HttpResponse response;
				//设置参数,html表单提交
				List<NameValuePair> paramlist=new ArrayList<NameValuePair>();
				
				JSONObject jsonRecord=new JSONObject();
				
				try {
					jsonRecord.put("adType", 28);
					jsonRecord.put("duringTime", "800");
					jsonRecord.put("userId", "000008");
				} catch (JSONException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				BasicNameValuePair param=new BasicNameValuePair("jsonArrpost", jsonRecord.toString());
				paramlist.add(param);
				
				try {
					httpPost.setEntity(new UrlEncodedFormEntity(paramlist,HTTP.UTF_8));
				} catch (UnsupportedEncodingException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				
				try {
					response=new DefaultHttpClient().execute(httpPost);
					int statusCode = response.getStatusLine().getStatusCode();
					if (statusCode==200) {
						String result=EntityUtils.toString(response.getEntity());
						msg.what=statusCode;
						msg.obj=result;
						mHandler_postrecord.sendMessage(msg);
					}
					
					
				} catch (ClientProtocolException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				
				
			}
		};
		mThread_postrecord.start();
	}
	
	public void showBanner_youmi(FrameLayout.LayoutParams vlayoutParams) {

		// 实例化广告条
		AdView adView = new AdView(mContext, AdSize.FIT_SCREEN);
		// 调用Activity的addContentView函数

		
		// 监听广告条接口
		adView.setAdListener(new AdViewListener() {

			@Override
			public void onSwitchedAd(AdView arg0) {
				Log.i("YoumiAdDemo", "广告条切换");
			}

			@Override
			public void onReceivedAd(AdView arg0) {
				Log.i("YoumiAdDemo", "请求广告成功");
				
				

			}

			@Override
			public void onFailedToReceivedAd(AdView arg0) {
				Log.i("YoumiAdDemo", "请求广告失败");
			}
		});
		mActivity.addContentView(adView, vlayoutParams);
	}
	
	private void showBanner_baidu(FrameLayout.LayoutParams vlayoutParams){
		com.baidu.mobads.AdView adViewbai=new com.baidu.mobads.AdView(mContext);
		mActivity.addContentView(adViewbai, vlayoutParams);
	}
	
	private void showBanner_gdt(FrameLayout.LayoutParams vlayoutParams){
		com.qq.e.ads.AdView adViewgdt= new com.qq.e.ads.AdView((Activity) mContext, com.qq.e.ads.AdSize.BANNER, "1104671462", "6040005399072658");
		AdRequest adr=new AdRequest();
		adViewgdt.fetchAd(adr);
		adViewgdt.setAdListener(new AdListener() {
			
			@Override
			public void onNoAd(int arg0) {
				// TODO Auto-generated method stub
				
			}
			
			@Override
			public void onNoAd() {
				// TODO Auto-generated method stub
				
			}
			
			@Override
			public void onBannerClosed() {
				// TODO Auto-generated method stub
				
			}
			
			@Override
			public void onAdReceiv() {
				// TODO Auto-generated method stub
				postDataToBackend("http://219.223.240.65:3000/addRecord");
				
			}
			
			@Override
			public void onAdExposure() {
				// TODO Auto-generated method stub
				
			}
			
			@Override
			public void onAdClicked() {
				// TODO Auto-generated method stub
				
				
			}
		});
		mActivity.addContentView(adViewgdt, vlayoutParams);
	}
	
	public void toast(String t) {
		Toast.makeText(mContext, t, 200).show();
	}
}
